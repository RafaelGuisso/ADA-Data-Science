create database bibliotech;
 
-- CRIA A TABELA LIVRO
CREATE TABLE LIVRO (
    CODIGO SERIAL PRIMARY KEY,
    TITULO VARCHAR(255) NOT NULL,
    EDITORA VARCHAR(255) NOT NULL,
    ANO INTEGER NOT NULL CHECK (ANO > 0),
    EDICAO INTEGER NOT NULL CHECK (EDICAO > 0),
    ISBN VARCHAR(13) UNIQUE NOT NULL,
    EXEMPLARES INTEGER NOT NULL CHECK (EXEMPLARES >= 0)
);


-- CRIA A TABELA ALUNO
CREATE TABLE ALUNO (
    MATRICULA INT PRIMARY KEY,
    NOME VARCHAR(255),
    EMAIL VARCHAR(100),
    CURSO VARCHAR(100)
);


-- CRIA A TABELA AUTOR
CREATE TABLE AUTOR (
    ID_AUTOR SERIAL PRIMARY KEY,
    NOME VARCHAR(255) NOT NULL,
    NACIONALIDADE VARCHAR(100) NOT NULL,
    DATA_NASCIMENTO DATE NOT NULL
);


 -- CRIA A TABELA EMPRESTIMO
CREATE TABLE EMPRESTIMO (
    ID_EMPRESTIMO SERIAL PRIMARY KEY ,
    MATRICULA INT,
    ISBN VARCHAR(13),
    DATA_EMPRESTIMO DATE,
    DATA_DEVOLUCAO DATE,
    MULTA BOOLEAN,
    FOREIGN KEY (MATRICULA) REFERENCES ALUNO(MATRICULA),
    FOREIGN KEY (ISBN) REFERENCES LIVRO(ISBN)
);


--  INSERIR DADOS DOS LIVROS
INSERT INTO LIVRO (TITULO, EDITORA, ANO, EDICAO, ISBN, EXEMPLARES) VALUES
('DATA SCIENCE DO ZERO', 'O''REILLY MEDIA', 2015, 1, '9781491957664', 1),
('PYTHON PARA ANÁLISE DE DADOS', 'NOVATEC', 2018, 1, '9788575224467', 1),
('BANCO DE DADOS', 'BOOKMAN', 2009, 1, '9788576082675', 1),
('MINERAÇÃO DE DADOS', 'BOOKMAN', 2011, 1, '9788576083375', 1),
('BIG DATA: A REVOLUÇÃO DOS DADOS', 'LEYA', 2014, 1, '9788582601572', 1),
('A ARTE DE TRANSFORMAR DADOS EM INSIGHT', 'GLOBOLIVROS', 2017, 1, '9788550809184', 1),
('ESTATÍSTICA BÁSICA', 'SARAIVA', 2017, 1, '9788573076103', 1),
('AVALIAÇÃO DE DESEMPENHO DE SISTEMAS COMPUTACIONAIS', 'BOOKMAN', 2013, 1, '9788576084778', 1),
('ANÁLISE DE DADOS COM PYTHON', 'LEYA', 2018, 1, '9788582600087', 1),
('MACHINE LEARNING: GUIA DE REFERÊNCIA RÁPIDA', 'NOVATEC', 2019, 1, '9788550805780', 1),
('DATA SCIENCE PARA NEGÓCIOS', 'ELSEVIER', 2013, 1, '9788535273806', 1),
('R PARA ESTATÍSTICOS', 'NOVATEC', 2013, 1, '9788575227185', 1),
('DEEP LEARNING', 'ELSEVIER', 2016, 1, '9788535279723', 1),
('ANÁLISE DE DADOS COM POWER BI', 'ALTA BOOKS', 2020, 1, '9788577805528', 1),
('INTRODUÇÃO À MINERAÇÃO DE DADOS', 'NOVATEC', 2003, 1, '9788550808873', 1),
('TABLEAU: GUIA COMPLETO', 'ALTA BOOKS', 2019, 1, '9788577806068', 1),
('SQL PERFORMANCE EXPLAINED', 'ALTA BOOKS', 2012, 1, '9788577806068', 1),
('BIG DATA: TÉCNICAS E TECNOLOGIAS PARA EXTRAÇÃO DE VALOR', 'BOOKMAN', 2014, 1, '9788576089919', 1),
('PANDAS: TRATAMENTO E ANÁLISE DE DADOS', 'NOVATEC', 2018, 1, '9788550805803', 1),
('PROBABILIDADE E ESTATÍSTICA PARA ENGENHARIA E CIÊNCIAS', 'CENGAGE LEARNING', 2016, 1, '9788575224467', 1),
('APRENDIZADO DE MÁQUINA', 'NOVATEC', 1997, 1, '9788575228120', 1),
('MINING THE SOCIAL WEB', 'NOVATEC', 2013, 1, '9788575228120', 1),
('INTRODUCTION TO DATA MINING', 'NOVATEC', 2006, 1, '9788550808644', 1),
('ESTATÍSTICA APLICADA À ADMINISTRAÇÃO E ECONOMIA', 'CENGAGE LEARNING', 2016, 1, '9788575226232', 1),
('HADOOP: THE DEFINITIVE GUIDE', 'NOVATEC', 2012, 1, '9788575228021', 1),
('DATA SCIENCE NA PRÁTICA', 'ALTA BOOKS', 2021, 1, '9788577809489', 1),
('AVALIAÇÃO DE DESEMPENHO DE SISTEMAS COMPUTACIONAIS', 'ELSEVIER', 2015, 1, '9788535280651', 1),
('MONGODB: CONSTRUA NOVAS APLICAÇÕES COM NOVAS TECNOLOGIAS', 'ALTA BOOKS', 2010, 1, '9788577801339', 1),
('DATA SCIENCE PARA LEIGOS', 'NOVATEC', 2017, 1, '9788550809849', 1),
('PROBABILIDADE E ESTATÍSTICA', 'CENGAGE LEARNING', 2012, 1, '9788575226232', 1)
ON CONFLICT (ISBN) DO NOTHING;

SELECT * FROM LIVRO;

 -- INSERIR DADOS DOS AUTORES
INSERT INTO AUTOR (NOME, NACIONALIDADE, DATA_NASCIMENTO) VALUES
('JOEL GRUS', 'AMERICANO', '1981-12-30'),
('WES MCKINNEY', 'AMERICANO', '1981-10-15'),
('CARLOS A. HEUSER', 'BRASILEIRO', '1952-04-23'),
('IAN H. WITTEN', 'NEOZELANDÊS', '1957-01-01'),
('KENNETH CUKIER', 'AMERICANO', '1968-01-01'),
('ALBERTO CAIRO', 'ESPANHOL', '1974-01-01'),
('WILTON O. BUSSAB', 'BRASILEIRO', '1934-03-07'),
('PAULO LÍCIO DE GEUS', 'BRASILEIRO', '1945-01-01'),
('TOM M. MITCHELL', 'AMERICANO', '1951-08-09'),
('MATT HARRISON', 'AMERICANO', '1978-01-01'),
('FOSTER PROVOST', 'AMERICANO', '1965-01-01'),
('PETER DALGAARD', 'DINAMARQUÊS', '1959-01-01'),
('IAN GOODFELLOW', 'AMERICANO', '1987-01-01'),
('CRISTOFER ENGLUND', 'AUSTRÍACO', '1970-01-01'),
('MARGARET H. DUNHAM', 'AMERICANA', '1950-01-01'),
('GEORGE PECK', 'AMERICANO', '1945-01-01'),
('MARKUS WINAND', 'AUSTRÍACO', '1976-01-01'),
('RICARDO PEZZUOL JACOBI', 'BRASILEIRO', '1955-01-01'),
('JAY L. DEVORE', 'AMERICANO', '1947-01-01'),
('TOM WHITE', 'AMERICANO', '1970-01-01'),
('DANIEL C. FURTADO', 'BRASILEIRO', '1945-01-01'),
('RUY DE OLIVEIRA', 'BRASILEIRO', '1940-01-01'),
('KYLE BANKER', 'AMERICANO', '1980-01-01'),
('LILLIAN PIERSON', 'AMERICANA', '1985-01-01'),
('GEORGE C. CANAVOS', 'AMERICANO', '1933-01-01');

SELECT * FROM AUTOR;

--  INSERIR DADOS DOS ALUNOS
INSERT INTO ALUNO (MATRICULA, NOME, EMAIL, CURSO) VALUES
(1001, 'JOÃO SILVA', 'JOAO.SILVA@UNIVERSIDADE.COM.BR', 'CIÊNCIA DE DADOS'),
(1002, 'MARIA SANTOS', 'MARIA.SANTOS@UNIVERSIDADE.COM.BR', 'ENGENHARIA DE DADOS'),
(1003, 'PEDRO OLIVEIRA', 'PEDRO.OLIVEIRA@UNIVERSIDADE.COM.BR', 'ESTATÍSTICA'),
(1004, 'ANA PEREIRA', 'ANA.PEREIRA@UNIVERSIDADE.COM.BR', 'CIÊNCIA DA COMPUTAÇÃO'),
(1005, 'CARLOS ROCHA', 'CARLOS.ROCHA@UNIVERSIDADE.COM.BR', 'SISTEMAS DE INFORMAÇÃO'),
(1006, 'FERNANDA LIMA', 'FERNANDA.LIMA@UNIVERSIDADE.COM.BR', 'MATEMÁTICA APLICADA'),
(1007, 'LUCAS SOUZA', 'LUCAS.SOUZA@UNIVERSIDADE.COM.BR', 'ENGENHARIA ELETRÔNICA'),
(1008, 'MARIANA OLIVEIRA', 'MARIANA.OLIVEIRA@UNIVERSIDADE.COM.BR', 'ANÁLISE DE SISTEMAS'),
(1009, 'RODRIGO SANTOS', 'RODRIGO.SANTOS@UNIVERSIDADE.COM.BR', 'INTELIGÊNCIA ARTIFICIAL'),
(1010, 'JULIANA COSTA', 'JULIANA.COSTA@UNIVERSIDADE.COM.BR', 'BANCO DE DADOS'),
(1011, 'DANIEL PEREIRA', 'DANIEL.PEREIRA@UNIVERSIDADE.COM.BR', 'CIÊNCIA DA INFORMAÇÃO'),
(1012, 'PATRÍCIA LIMA', 'PATRICIA.LIMA@UNIVERSIDADE.COM.BR', 'GESTÃO DA TECNOLOGIA DA INFORMAÇÃO');

SELECT * FROM ALUNO;

 -- INSERIR DADOS DOS EMPRÉSTIMOS
INSERT INTO EMPRESTIMO (MATRICULA, ISBN, DATA_EMPRESTIMO, DATA_DEVOLUCAO, MULTA) VALUES
(1001, '9781491957664', '2023-12-01', '2023-12-15', FALSE),
( 1002, '9788575224467', '2023-12-05', '2023-12-19', TRUE),
( 1003, '9788576082675', '2023-12-10', '2023-12-24', FALSE),
( 1004, '9788576083375', '2023-12-15', NULL, FALSE),
( 1005, '9788582601572', '2023-12-20', '2023-12-30', FALSE),
( 1006, '9788550809184', '2023-12-25', NULL, FALSE),
( 1007, '9788573076103', '2023-12-30', '2023-12-24', FALSE),
( 1008, '9788576084778', '2024-01-05', '2023-05-24', FALSE),
( 1009, '9788582600087', '2024-01-10', NULL, FALSE),
( 1010, '9788550805780', '2024-01-15', NULL, FALSE),
( 1011, '9788535273806', '2024-01-20', '2023-12-26', TRUE),
( 1012, '9788577806068', '2024-01-25', NULL, FALSE);

SELECT * FROM EMPRESTIMO;

-- MAIS DADOS NA FATO
 -- INSERIR DADOS ADICIONAIS DE EMPRÉSTIMOS
INSERT INTO EMPRESTIMO (MATRICULA, ISBN, DATA_EMPRESTIMO, DATA_DEVOLUCAO, MULTA) VALUES
( 1011, '9788577806068', '2023-12-03', NULL, FALSE),
( 1012, '9788575224467', '2023-12-05', NULL, FALSE),
( 1001, '9781491957664', '2023-12-07', '2023-12-21', FALSE),
( 1002, '9788575224467', '2023-12-10', '2023-12-24', FALSE),
( 1003, '9788576082675', '2023-12-14', '2023-12-28', FALSE),
( 1004, '9788576083375', '2023-12-17', '2023-12-31', FALSE),
( 1005, '9788582601572', '2023-12-20', NULL, FALSE),
( 1006, '9788550809184', '2023-12-23', NULL, FALSE),
( 1007, '9788573076103', '2023-12-26', NULL, FALSE),
( 1008, '9788576084778', '2023-12-29', NULL, FALSE),
( 1009, '9788582600087', '2023-12-31', NULL, FALSE),
( 1010, '9788550805780', '2023-12-02', '2023-12-16', FALSE),
( 1011, '9788535273806', '2023-12-08', '2023-12-22', FALSE),
( 1012, '9788577806068', '2023-12-12', '2023-12-26', TRUE),
( 1001, '9788577805528', '2023-12-18', '2023-12-29', FALSE),
( 1002, '9788576082675', '2023-12-21', NULL, FALSE),
( 1003, '9788577806068', '2023-12-24', NULL, FALSE),
( 1004, '9788577805528', '2023-12-27', NULL, FALSE),
( 1005, '9788576082675', '2023-12-29', NULL, FALSE),
( 1006, '9788576084778', '2023-12-30', NULL, FALSE),
( 1007, '9788582601572', '2023-12-01', '2023-12-15', FALSE),
( 1008, '9788550809184', '2023-12-05', '2023-12-19', TRUE),
( 1009, '9788535273806', '2023-12-10', '2023-12-24', FALSE),
( 1010, '9788576084778', '2023-12-15', NULL, FALSE),
( 1011, '9788582600087', '2023-12-20', NULL, FALSE),
( 1012, '9788550805780', '2023-12-25', NULL, FALSE),
( 1001, '9788573076103', '2023-12-30', NULL, FALSE),
( 1002, '9788576084778', '2023-12-05', NULL, FALSE),
( 1003, '9788582600087', '2023-12-10', NULL, FALSE),
( 1004, '9788550805780', '2023-12-15', NULL, FALSE),
( 1005, '9788535273806', '2023-12-20', NULL, FALSE),
( 1006, '9788577806068', '2023-12-25', NULL, FALSE);


 -- INSERIR 50 REGISTROS ADICIONAIS DE EMPRÉSTIMOS PARA OS ISBNS ESPECIFICADOS E MATRICULAS FORNECIDAS
INSERT INTO EMPRESTIMO (MATRICULA, ISBN, DATA_EMPRESTIMO, DATA_DEVOLUCAO, MULTA)
VALUES
(1001, '9788535279723', '2023-12-01', '2023-12-15', FALSE),
(1002, '9788535280651', '2023-12-05', '2023-12-19', TRUE),
(1003, '9788550805803', '2023-12-10', '2023-12-24', FALSE),
(1004, '9788550808644', '2023-12-15', '2023-12-29', FALSE),
(1005, '9788550808873', '2023-12-20', '2023-12-28', FALSE),
(1006, '9788550809849', '2023-12-25', '2023-12-30', FALSE),
(1007, '9788575226232', '2023-12-30', '2023-12-24', FALSE),
(1008, '9788575227185', '2023-12-05', '2023-12-24', FALSE),
(1009, '9788575228021', '2023-12-10', '2023-12-26', FALSE),
(1010, '9788575228120', '2023-12-15', '2023-12-28', FALSE),
(1011, '9788577805528', '2023-12-20', '2023-12-27', FALSE),
(1012, '9788577809489', '2023-12-25', '2023-12-26', FALSE),
(1001, '9788535279723', '2023-12-29', '2023-12-25', FALSE),
(1002, '9788535280651', '2023-12-28', '2023-12-27', FALSE),
(1003, '9788550805803', '2023-12-27', '2023-12-26', FALSE),
(1004, '9788550808644', '2023-12-26', '2023-12-29', FALSE),
(1005, '9788550808873', '2023-12-22', '2023-12-30', FALSE),
(1006, '9788550809849', '2023-12-23', '2023-12-28', FALSE),
(1007, '9788575226232', '2023-12-24', '2023-12-27', FALSE),
(1008, '9788575227185', '2023-12-25', '2023-12-26', FALSE),
(1009, '9788575228021', '2023-12-26', '2023-12-29', FALSE),
(1010, '9788575228120', '2023-12-27', '2023-12-30', FALSE),
(1011, '9788577805528', '2023-12-28', '2023-12-28', FALSE),
(1012, '9788577809489', '2023-12-29', '2023-12-29', FALSE),
(1001, '9788535279723', '2023-12-01', '2023-12-15', FALSE),
(1002, '9788535280651', '2023-12-05', '2023-12-19', TRUE),
(1003, '9788550805803', '2023-12-10', '2023-12-24', FALSE),
(1004, '9788550808644', '2023-12-15', '2023-12-29', FALSE),
(1005, '9788550808873', '2023-12-20', '2023-12-28', FALSE),
(1006, '9788550809849', '2023-12-25', '2023-12-30', FALSE),
(1007, '9788575226232', '2023-12-30', '2023-12-24', FALSE),
(1008, '9788575227185', '2023-12-05', '2023-12-24', FALSE),
(1009, '9788575228021', '2023-12-10', '2023-12-26', FALSE),
(1010, '9788575228120', '2023-12-15', '2023-12-28', FALSE),
(1011, '9788577805528', '2023-12-20', '2023-12-27', FALSE),
(1012, '9788577809489', '2023-12-25', '2023-12-26', FALSE);

SELECT * FROM EMPRESTIMO;

 -- ANALISE DE DADOS CONSULTAS

-- TOTAL DE LIVOS NA BIBLIOTECA
SELECT COUNT(*) AS TOTAL_LIVROS FROM LIVRO; 

-- LIVRO MAIS ANTIGO 
SELECT ISBN, TITULO, ANO FROM LIVRO ORDER BY ANO ASC LIMIT 1;

-- CONSULTA DOS 5 AUTORES MAIS RECENTES
SELECT NOME, DATA_NASCIMENTO FROM AUTOR ORDER BY DATA_NASCIMENTO DESC LIMIT 5;


-- QUANTAS VEZES O LIVRO MAIS VELHO FOI ALUGADO
SELECT 
	COUNT(EM.ID_EMPRESTIMO)
FROM 
	EMPRESTIMO AS EM
	INNER JOIN LIVRO AS LI
	ON LI.ISBN = EM.ISBN 
WHERE 
	LI.ISBN = (SELECT ISBN FROM LIVRO ORDER BY ANO DESC LIMIT 1)
	
-- LIVRO SEM EMPRESTIMOS
SELECT 
	LI.TITULO 
FROM 
	EMPRESTIMO AS EM
	RIGHT JOIN LIVRO AS LI
	ON LI.ISBN = EM.ISBN 	
WHERE 
	ID_EMPRESTIMO IS NULL
	
-- QTDE DE LIVROS POR CURSOS
SELECT 
	CURSO 
	, COUNT(E.ID_EMPRESTIMO)
FROM 
	EMPRESTIMO E 
	LEFT JOIN ALUNO A 
	ON A.MATRICULA = E.MATRICULA 
GROUP BY 
	CURSO 
ORDER BY 
	2 DESC;


 -- SUBQUERY PARA SUBCONSULTA COM A MEDIA DE EMPRESTIMOS POR ALUNOS
SELECT SUBQUERY.NOME, AVG(SUBQUERY.TOTAL_EMPRESTIMOS) AS MEDIA_EMPRESTIMOS
FROM (
    SELECT A.NOME, COUNT(E.ID_EMPRESTIMO) AS TOTAL_EMPRESTIMOS
    FROM EMPRESTIMO E
    LEFT JOIN ALUNO A ON E.MATRICULA = A.MATRICULA
    GROUP BY A.NOME
) AS SUBQUERY
GROUP BY SUBQUERY.NOME;

 -- MAIS ANALISES

 -- LIVROS MAIS BUSCADOS

SELECT LI.TITULO, COUNT(EM.ID_EMPRESTIMO) AS TOTAL_EMPRESTIMOS
FROM LIVRO LI
LEFT JOIN EMPRESTIMO EM ON LI.ISBN = EM.ISBN
GROUP BY LI.TITULO
ORDER BY TOTAL_EMPRESTIMOS DESC LIMIT 5;


 -- LIVROS QUE POSSUEM MAIS MULTAS 

SELECT li.titulo, COUNT(e.id_emprestimo) AS total_emprestimos, SUM(CAST(e.multa AS INT)) AS total_multas
FROM livro li
LEFT JOIN emprestimo e ON li.isbn = e.isbn
WHERE e.multa IS NOT null -- filtra removendo os valores nulos.
GROUP BY li.titulo
ORDER BY total_multas DESC;


 -- MEDIA DE EMPRESTIMOS POR ALUNO

SELECT A.NOME, AVG(SUBQUERY.TOTAL_EMPRESTIMOS) AS MEDIA_EMPRESTIMOS
FROM (
    SELECT E.MATRICULA, COUNT(E.ID_EMPRESTIMO) AS TOTAL_EMPRESTIMOS
    FROM EMPRESTIMO E
    GROUP BY E.MATRICULA
) AS SUBQUERY
LEFT JOIN ALUNO A ON SUBQUERY.MATRICULA = A.MATRICULA
GROUP BY A.NOME
ORDER BY MEDIA_EMPRESTIMOS DESC;


